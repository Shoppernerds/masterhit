<!doctype html> 
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>MasterHit | Cartas Pok√©mon en Chile</title>
<meta name="description" content="MasterHit: tienda de cartas Pok√©mon TCG. Env√≠os a todo Santiago." />
<meta property="og:title" content="MasterHit | Cartas Pok√©mon en Chile">
<meta property="og:description" content="Cajas selladas, ETB, boosters y singles. Env√≠os a todo Chile.">
<meta property="og:type" content="website">

<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 256 256'%3E%3Ccircle cx='128' cy='128' r='120' fill='%23e60000'/%3E%3Ccircle cx='128' cy='128' r='88' fill='%23fff'/%3E%3Ccircle cx='128' cy='128' r='40' fill='%23000'/%3E%3C/svg%3E">
<style>
:root{--bg:#0b0b0c;--card:#111215;--muted:#9aa2ae;--line:#20242b;--fg:#f5f7fb;--accent:#e60000;--accent-2:#fff;--radius:16px;--shadow:0 10px 30px rgba(0,0,0,.45)}
*{box-sizing:border-box}html,body{margin:0;height:100%;background:var(--bg);color:var(--fg);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
a{color:inherit;text-decoration:none}img{max-width:100%;display:block}
.container{max-width:1200px;margin:0 auto;padding:20px}

/* NAV */
.nav{position:sticky;top:0;z-index:50;background:#000;border-bottom:2px solid var(--accent)}
.nav-inner{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:14px 20px}
.brand{display:flex;gap:10px;align-items:center;font-weight:800;color:var(--accent-2)}
/* Pok√©bola */
.brand-badge{position:relative;width:28px;height:28px;border-radius:999px;background:linear-gradient(#e60000 0 50%, #fff 50% 100%);box-shadow:0 0 0 3px #000,0 0 0 6px #fff;overflow:hidden}
.brand-badge:before{content:"";position:absolute;left:0;right:0;top:50%;height:3px;background:#000;transform:translateY(-50%)}
.brand-badge:after{content:"";position:absolute;inset:0;margin:auto;width:10px;height:10px;border-radius:50%;background:#000;box-shadow:0 0 0 3px #fff,0 0 0 5px #000}

/* Buttons */
.btn{cursor:pointer;border-radius:12px;border:1px solid var(--line);background:var(--card);color:var(--fg);padding:10px 14px;display:inline-flex;align-items:center;gap:8px}
.btn.primary{background:var(--accent);border-color:var(--accent);color:#fff}
.cart-count{display:inline-flex;min-width:22px;height:22px;border-radius:999px;align-items:center;justify-content:center;background:#fff;color:#000;font-weight:800;font-size:.85rem;padding:0 6px}

/* HERO */
.hero{padding:36px 20px;text-align:center;background:#111}
.hero h1{font-size:1.6rem;color:#fff;margin:0}
.hero .hero-sub{margin:8px 0 0 0;font-size:1rem;color:#f0f0f0}

/* CONTROLS + GRID */
.controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center;padding:0 20px}
.counter{color:var(--fg);font-weight:800;font-size:1.1rem;padding:10px 14px;border-left:3px solid var(--accent);border-radius:8px;background:#0f1116}

/* Filtros (categor√≠a + tipo/idioma) */
.filters-wrap{display:flex;gap:14px;align-items:center;margin-left:auto;flex-wrap:wrap}
.filters-group{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.filter-label{font-size:.95rem;color:#cdd3dd;margin-right:6px}
.filter-btn{cursor:pointer;border-radius:999px;border:1px solid var(--line);background:#0f1116;color:#fff;padding:8px 12px;font-size:.9rem}
.filter-btn.active{background:var(--accent);border-color:var(--accent)}

/* Grid */
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:14px;padding:20px}
.product{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden;display:flex;flex-direction:column;position:relative}
.product img{height:200px;object-fit:contain;background:#fff}
.pad{padding:12px;flex:1;display:flex;flex-direction:column;gap:8px}
.price{font-weight:800;color:var(--accent-2)}
.badge{background:var(--accent);color:#fff;padding:4px 8px;border-radius:6px;font-size:.8rem;position:absolute;margin:6px}
.badge.low{background:rgba(245,158,11,.15);color:#fde68a;border:1px solid rgba(245,158,11,.35)}
.badge.oos{background:#444;color:#ddd;border:1px solid #666}
/* Preventa (m√°s peque√±a + nuevo texto) */
.badge.preorder{right:6px;top:6px;background:linear-gradient(90deg,#e60000,#b60000);border:1px solid rgba(255,255,255,.15);padding:3px 6px;font-size:.72rem}

/* Precios */
.price-wrap{display:flex;align-items:baseline;gap:10px;flex-wrap:wrap}
.price-new{font-weight:900;font-size:1.05rem;color:#fff}
.price-old{color:var(--muted);text-decoration:line-through}
.save-tag{background:rgba(230,0,0,.15);color:#fff;border:1px solid rgba(230,0,0,.35);padding:2px 8px;border-radius:999px;font-size:.75rem}

/* Drawer carrito */
.drawer{position:fixed;right:0;top:0;height:100%;width:420px;max-width:100%;background:#111;color:#fff;border-left:2px solid var(--accent);transform:translateX(100%);transition:.3s;z-index:100;display:flex;flex-direction:column}
.drawer.open{transform:translateX(0)}
.row{display:grid;grid-template-columns:64px 1fr auto;gap:10px;align-items:center;border:1px solid var(--line);border-radius:12px;padding:8px}
.row img{width:64px;height:64px;object-fit:contain;background:#fff}

/* Modal gen√©rico */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;place-items:center;z-index:90}
.modal.open{display:grid}
.modal-card{width:min(900px,95vw);background:#111;border:1px solid var(--line);border-radius:16px;box-shadow:var(--shadow);overflow:hidden}
.modal-body{display:grid;grid-template-columns:1fr 1fr;gap:16px;padding:16px}
.thumbs{display:flex;gap:8px;flex-wrap:wrap}
.thumbs img{width:64px;height:64px;object-fit:contain;background:#fff;border:1px solid var(--line);border-radius:8px;cursor:pointer}
@media (max-width:800px){.modal-body{grid-template-columns:1fr}}

/* CHECKOUT modal */
.checkout-card{width:min(780px,95vw);background:#111;border:1px solid var(--line);border-radius:16px;box-shadow:var(--shadow);overflow:hidden}
.checkout-body{padding:16px;display:grid;gap:16px}
.section{border:1px solid var(--line);border-radius:12px;padding:12px}
.section h3{margin:0 0 8px 0;font-size:1rem}
.input, select, textarea{width:100%;border-radius:10px;border:1px solid var(--line);background:#0f1116;color:#fff;padding:10px}
.input::placeholder, textarea::placeholder{color:#9aa2ae}
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
.help{font-size:.85rem;color:#9aa2ae}
.flex{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.badge-inline{background:#0f1116;border:1px solid var(--line);border-radius:999px;padding:6px 10px}
.code{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;background:#0f1116;border:1px dashed var(--line);padding:8px;border-radius:8px}

/* Footer */
footer{padding:24px 20px;background:#000;color:#fff;margin-top:30px}
.footer-inner{max-width:1200px;margin:0 auto;display:grid;gap:6px}
.footer-title{font-weight:800;font-size:1.1rem}

/* Desktop */
@media (min-width:768px){
  .footer-inner{grid-template-columns:1fr auto;align-items:center}
  .footer-btn{justify-self:end}
}

/* Mobile ‚â§640 */
@media (max-width:640px){
  .grid{grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
  .product img{height:150px}
  .pad{padding:10px}
  .footer-inner{grid-template-columns:1fr;gap:10px;text-align:center}
  .footer-btn{grid-row:1;justify-self:center;margin-bottom:10px}
  .footer-info{grid-row:2}
}
</style>
</head>
<body>

<!-- NAV -->
<nav class="nav" aria-label="Barra superior">
  <div class="nav-inner container">
    <a href="#" class="brand" aria-label="MasterHit inicio"><span class="brand-badge" aria-hidden="true"></span> MASTERHIT</a>
    <div class="toolbar">
      <button id="btnCart" class="btn primary" aria-haspopup="dialog" aria-controls="drawer">
        üõí Ver tu Carrito de Compras <span class="cart-count" id="cCount">0</span>
      </button>
    </div>
  </div>
</nav>

<!-- HERO -->
<section class="hero" aria-label="Mensaje principal">
  <h1>Los maestros del Pokemon TCG en el Norte de Santiago: nuestra tienda es 100% online para asegurarte el mejor precio.</h1>
  <p class="hero-sub">Aprovecha nuestras Ofertas Insuprables: productos al costo por tiempo limitado.</p>
</section>

<!-- CONTROLS -->
<div class="controls container">
  <span id="counter" class="counter">Sellados Disponibles:</span>
  <!-- Filtros (misma altura que el counter) -->
  <div class="filters-wrap" role="toolbar" aria-label="Filtros de cat√°logo">
    <div class="filters-group" id="filtersCat" aria-label="Filtrar por categor√≠a"></div>
    <div class="filters-group" id="filtersType" aria-label="Filtrar por tipo/idioma"></div>
  </div>
</div>

<!-- GRID -->
<section class="container">
  <div id="grid" class="grid" aria-live="polite"></div>
</section>

<!-- DRAWER CARRITO -->
<aside id="drawer" class="drawer" aria-hidden="true" role="dialog" aria-label="Carrito de compras">
  <header style="padding:12px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;align-items:center">
    <strong>Tu carrito</strong>
    <button id="btnClose" class="btn" aria-label="Cerrar carrito">‚úï</button>
  </header>
  <div id="cartBody" style="flex:1;overflow:auto;padding:12px"></div>
  <div style="padding:12px;border-top:1px solid var(--line)">
    <div>Subtotal: <strong id="subtotal">‚Äî</strong></div>
    <div>Total: <strong id="grand">‚Äî</strong></div>
    <button id="btnCheckout" class="btn primary" style="margin-top:10px;width:100%">Proceder a pago (Transferencia)</button>
    <small class="muted">* √önico medio de pago: transferencia bancaria.</small>
  </div>
</aside>

<!-- MODAL DETALLE PRODUCTO -->
<div id="modal" class="modal" role="dialog" aria-modal="true" aria-label="Detalle de producto">
  <div class="modal-card">
    <header style="display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border-bottom:1px solid var(--line)">
      <strong id="mTitle"></strong>
      <button id="mClose" class="btn" aria-label="Cerrar detalle">‚úï</button>
    </header>
    <div class="modal-body">
      <div>
        <img id="mImage" src="" alt="" style="width:100%;height:360px;object-fit:contain;background:#fff" loading="lazy" decoding="async" />
        <div id="mThumbs" class="thumbs" aria-label="Galer√≠a miniaturas"></div>
      </div>
      <div>
        <p id="mMeta" class="muted"></p>
        <p><strong id="mPrice"></strong></p>
        <div class="qty" style="margin:10px 0">
          <button class="btn" id="mDec" aria-label="Disminuir">‚àí</button>
          <input class="input" id="mQty" style="width:60px;text-align:center" type="number" min="1" value="1" aria-label="Cantidad">
          <button class="btn" id="mInc" aria-label="Aumentar">+</button>
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button id="mAdd" class="btn primary">A√±adir al carrito</button>
          <button id="mView" class="btn">Ver imagen completa</button>
        </div>
        <p id="mDesc" class="muted" style="margin-top:12px"></p>
      </div>
    </div>
  </div>
</div>

<!-- MODAL CHECKOUT (Datos + Confirmaci√≥n) -->
<div id="checkout" class="modal" role="dialog" aria-modal="true" aria-label="Checkout">
  <div class="checkout-card">
    <header style="display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border-bottom:1px solid var(--line)">
      <strong>Finalizar compra (Transferencia)</strong>
      <button id="coClose" class="btn" aria-label="Cerrar checkout">‚úï</button>
    </header>
    <div class="checkout-body">
      <!-- Paso 1: Datos -->
      <div class="section" id="coStep1">
        <h3>1) Tus datos y entrega</h3>
        <div class="grid-2">
          <div>
            <label>Nombre y Apellido</label>
            <input id="coName" class="input" placeholder="Ej: Jorge G√°lvez" autocomplete="name">
          </div>
          <div>
            <label>RUT</label>
            <input id="coRut" class="input" placeholder="11111111-1">
          </div>
        </div>
        <div class="grid-2">
          <div>
            <label>WhatsApp</label>
            <input id="coPhone" class="input" placeholder="+56 9 1234 5678" autocomplete="tel">
          </div>
          <div>
            <label>Email</label>
            <input id="coEmail" class="input" placeholder="tucorreo@dominio.cl" autocomplete="email">
          </div>
        </div>

        <div class="grid-2">
          <div>
            <label>M√©todo de entrega</label>
            <select id="coMethod" class="input">
              <option value="retiro">Retiro en Valle Grande (Lampa)</option>
              <option value="despacho">Despacho Zona Norte de Santiago</option>
            </select>
            <p class="help">Retiro: <span class="badge-inline">Los Nogales 1135, Valle Grande, Lampa</span></p>
          </div>
          <div>
            <label>Horario preferido</label>
            <select id="coSlot" class="input">
              <option>Ma√±ana (10:00‚Äì13:00)</option>
              <option>Tarde (14:00‚Äì18:00)</option>
              <option>Noche (18:00‚Äì21:00)</option>
            </select>
          </div>
        </div>

        <div id="coAddressWrap" class="section" style="display:none;margin-top:6px">
          <h3>Direcci√≥n de entrega</h3>
          <div class="grid-2">
            <div>
              <label>Calle y n√∫mero</label>
              <input id="coStreet" class="input" placeholder="Ej: Av. Principal 1234">
            </div>
            <div>
              <label>Depto / Casa / Block</label>
              <input id="coUnit" class="input" placeholder="Ej: Depto 504, Torre B">
            </div>
          </div>
          <div class="grid-3">
            <div>
              <label>Comuna</label>
              <input id="coComuna" class="input" placeholder="Ej: Lampa / Quilicura / Colina">
            </div>
            <div>
              <label>Referencia</label>
              <input id="coRef" class="input" placeholder="Ej: Port√≥n negro, cerca de plaza">
            </div>
            <div>
              <label>Contacto en domicilio</label>
              <input id="coContact" class="input" placeholder="Ej: Juan P√©rez">
            </div>
          </div>
          <p class="help">* El costo de despacho se confirma por WhatsApp antes de transferir.</p>
        </div>

        <div>
          <label>Notas</label>
          <textarea id="coNotes" class="input" rows="2" placeholder="Ind√≠canos cualquier detalle adicional"></textarea>
        </div>

        <label style="display:flex;gap:8px;align-items:center">
          <input type="checkbox" id="coTerms"> Acepto t√©rminos de compra y pol√≠tica de cambios.
        </label>

        <div class="flex" style="justify-content:flex-end">
          <button id="coNext" class="btn primary">Continuar</button>
        </div>
      </div>

      <!-- Paso 2: Confirmaci√≥n + Transferencia -->
      <div class="section" id="coStep2" style="display:none">
        <h3>2) Confirma y transfiere</h3>
        <div class="grid-2">
          <div>
            <strong>Resumen del pedido</strong>
            <div id="coSummary" class="code" style="margin-top:8px;white-space:pre-wrap"></div>
            <div class="flex" style="margin-top:8px">
              <button id="btnCopySummary" class="btn">Copiar resumen</button>
            </div>
          </div>
          <div>
            <strong>Datos para Transferencia</strong>
            <div id="coBank" class="code" style="margin-top:8px"></div>
            <div class="flex" style="margin-top:8px">
              <button id="btnCopyBank" class="btn">Copiar datos</button>
              <a id="btnWA" class="btn primary" target="_blank" rel="noopener">Enviar por WhatsApp</a>
            </div>
            <p class="help" style="margin-top:8px">Adjunta el comprobante. Validamos y coordinamos entrega/Despacho 24h Zona Norte.</p>
          </div>
        </div>

        <div class="flex" style="justify-content:space-between">
          <button id="coBack" class="btn">Volver</button>
          <button id="coFinish" class="btn primary">He transferido / Finalizar</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- FOOTER -->
<footer>
  <div class="footer-inner">
    <div class="footer-info">
      <div class="footer-title">MasterHit</div>
      <div>Los Nogales 1135, Valle Grande, Lampa</div>
      <div>Lunes a Viernes 14:00 a 21:00 hrs</div>
      <div>S√°bados y Domingos 12:00 a 20:00 hrs</div>
    </div>
    <div class="footer-btn">
      <a class="btn primary" href="https://wa.me/56975121963" target="_blank" rel="noopener">üì≤ Contacta a un ejecutivo</a>
    </div>
  </div>
</footer>

<script>
window.addEventListener('DOMContentLoaded', () => {
  const $=s=>document.querySelector(s), fmt=n=>new Intl.NumberFormat('es-CL',{style:'currency',currency:'CLP',maximumFractionDigits:0}).format(n||0);
  let PRODUCTS=[], CART=JSON.parse(localStorage.getItem('mh_cart')||'[]'), CURRENT=null;

  /* ====== EDITA TUS DATOS BANCARIOS AQU√ç ====== */
  const BANK = {
    holder: 'MasterHit SpA',
    rut: '77.777.777-7',
    bank: 'Banco Falabella',
    type: 'Cuenta Vista',
    number: '12345678',
    email: 'pagos@masterhit.cl',
    whatsapp: '+56975121963'
  };
  /* ============================================ */

  // Filtros
  let ACTIVE_CATEGORY='ALL', ACTIVE_TYPE='ALL';

  const FALLBACK=[
    {id:'etb-151',name:'Elite Trainer Box 151',set:'SV151',category:'Elite Trainer Box',type:'INGL√âS',price:49990,stock:12,image:'https://dummyimage.com/600x400/fff/000&text=ETB+151',compareAtPrice:59990},
    {id:'upc-charizard',name:'Ultra Premium Charizard',set:'Promo',category:'Ultra Premium Collection',type:'INGL√âS',price:129990,stock:5,image:'https://dummyimage.com/600x400/fff/000&text=UPC+Charizard',compareAtPrice:149990},
    {id:'booster-box',name:'Booster Box Scarlet & Violet',set:'SV Base',category:'Booster Box',type:'ESPA√ëOL',price:159990,stock:3,image:'https://dummyimage.com/600x400/fff/000&text=Booster+Box',compareAtPrice:179990}
  ];

  const grid=$('#grid'),counter=$('#counter'),btnCart=$('#btnCart'),drawer=$('#drawer'),btnClose=$('#btnClose'),
        cartBody=$('#cartBody'),subtotalEl=$('#subtotal'),grandEl=$('#grand'),cCount=$('#cCount'),
        btnCheckout=$('#btnCheckout'),
        modal=$('#modal'),mClose=$('#mClose'),mTitle=$('#mTitle'),mImage=$('#mImage'),mThumbs=$('#mThumbs'),
        mMeta=$('#mMeta'),mPrice=$('#mPrice'),mQty=$('#mQty'),mDec=$('#mDec'),mInc=$('#mInc'),mAdd=$('#mAdd'),mView=$('#mView'),mDesc=$('#mDesc');

  // Checkout elements
  const coModal=$('#checkout'),coClose=$('#coClose'),
        coStep1=$('#coStep1'),coStep2=$('#coStep2'),
        coName=$('#coName'),coRut=$('#coRut'),coPhone=$('#coPhone'),coEmail=$('#coEmail'),
        coMethod=$('#coMethod'),coAddressWrap=$('#coAddressWrap'),
        coStreet=$('#coStreet'),coUnit=$('#coUnit'),coComuna=$('#coComuna'),coRef=$('#coRef'),coContact=$('#coContact'),
        coSlot=$('#coSlot'),coNotes=$('#coNotes'),coTerms=$('#coTerms'),
        coNext=$('#coNext'),coBack=$('#coBack'),coFinish=$('#coFinish'),
        coSummary=$('#coSummary'),coBank=$('#coBank'),btnCopySummary=$('#btnCopySummary'),btnCopyBank=$('#btnCopyBank'),btnWA=$('#btnWA');

  // Filtros (DOM)
  const filtersCatEl=$('#filtersCat'),filtersTypeEl=$('#filtersType');

  async function loadCatalog(){
    try{
      const r=await fetch('./masterhit-products.json?_='+Date.now());
      if(!r.ok) throw 0;
      const d=await r.json();
      PRODUCTS=Array.isArray(d)&&d.length?d:FALLBACK;
    }catch{
      PRODUCTS=FALLBACK
    }
    counter.textContent='Sellados Disponibles:';
    buildCategoryFilters();
    buildTypeFilters();
    render();
    updateBadge();
  }

  /* ahorro % */
  const savePct = (p) =>
    (p && p.compareAtPrice && p.compareAtPrice > p.price)
      ? Math.round((1 - (p.price / p.compareAtPrice)) * 100)
      : 0;

  /* Detectar PREVENTA (Mega Evolutions / Mega Evoluci√≥n, con o sin espacio/guion, singular/plural) */
  function isPreorder(p){
    if(!p || !p.name) return false;
    const name=(p.name+'').normalize('NFD').replace(/\p{Diacritic}/gu,'').toLowerCase();
    // cubre: "mega evolutions", "mega-evolutions", "mega evolution"
    // y espa√±ol: "mega evolucion", "mega evoluciones", "mega-evolucion(es)"
    return /\bmega[\s-]*evolutions?\b|\bmega[\s-]*evolucion(?:es)?\b/.test(name);
  }

  /* Normalizadores */
  const norm = s => (s||'').toString().trim();
  const normLower = s => norm(s).normalize('NFD').replace(/\p{Diacritic}/gu,'').toLowerCase();

  /* Filtros por categor√≠a */
  function buildCategoryFilters(){
    const cats = Array.from(new Set(PRODUCTS.map(p=>norm(p.category)).filter(Boolean))).sort((a,b)=>a.localeCompare(b));
    const buttons = [
      `<span class="filter-label">Categor√≠a:</span>`,
      `<button class="filter-btn ${ACTIVE_CATEGORY==='ALL'?'active':''}" data-cat="ALL">Todos</button>`,
      ...cats.map(c=>`<button class="filter-btn ${normLower(ACTIVE_CATEGORY)===normLower(c)?'active':''}" data-cat="${c}">${c}</button>`)
    ].join('');
    filtersCatEl.innerHTML = buttons;
  }

  /* Filtros por tipo/idioma (encadenado a categor√≠a) */
  function buildTypeFilters(){
    let base=[...PRODUCTS];
    if(ACTIVE_CATEGORY!=='ALL'){ base=base.filter(p=>normLower(p.category)===normLower(ACTIVE_CATEGORY)); }
    const types = Array.from(new Set(base.map(p=>norm(p.type)).filter(Boolean))).sort((a,b)=>a.localeCompare(b));
    if(ACTIVE_TYPE!=='ALL' && !types.some(t=>normLower(t)===normLower(ACTIVE_TYPE))){ ACTIVE_TYPE='ALL'; }
    const buttons = [
      `<span class="filter-label">Tipo/Idioma:</span>`,
      `<button class="filter-btn ${ACTIVE_TYPE==='ALL'?'active':''}" data-type="ALL">Todos</button>`,
      ...types.map(t=>`<button class="filter-btn ${normLower(ACTIVE_TYPE)===normLower(t)?'active':''}" data-type="${t}">${t}</button>`)
    ].join('');
    filtersTypeEl.innerHTML = buttons;
  }

  function getList(){
    let list=[...PRODUCTS];
    if(ACTIVE_CATEGORY!=='ALL'){ list=list.filter(p=>normLower(p.category)===normLower(ACTIVE_CATEGORY)); }
    if(ACTIVE_TYPE!=='ALL'){ list=list.filter(p=>normLower(p.type)===normLower(ACTIVE_TYPE)); }
    list.sort((a,b)=>(b.stock|0)-(a.stock|0));
    return list;
  }

  function render(){
    const list=getList();
    grid.innerHTML=list.map((p,i)=>{
      const low=(p.stock|0)>0 && (p.stock|0)<=3, oos=(p.stock|0)===0;
      const hasCompare=p.compareAtPrice && p.compareAtPrice>p.price;
      const ahorro=savePct(p);
      const preorder=isPreorder(p);

      return `<article class="product">
        ${i<4?`<span class="badge">Oferta al costo</span>`:''}
        ${preorder?`<span class="badge preorder">Preventa 26/09</span>`:''}
        ${oos?`<span class="badge oos">Sin stock</span>`:low?`<span class="badge low">¬°Quedan ${p.stock}!</span>`:''}
        <img src="${p.image}" alt="${p.name}" loading="lazy" decoding="async" referrerpolicy="no-referrer">
        <div class="pad">
          <strong>${p.name}</strong>
          <span class="muted">${[p.set,p.type,p.category].filter(Boolean).join(' ‚Ä¢ ')}</span>
          <div class="price-wrap">
            <span class="price-new">${fmt(p.price)}</span>
            ${hasCompare?`<span class="price-old">${fmt(p.compareAtPrice)}</span>${ahorro>0?`<span class="save-tag">Ahorra ${ahorro}%</span>`:''}`:''}
          </div>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button class="btn primary" data-add data-id="${p.id}" ${oos?'disabled':''}>A√±adir</button>
            <button class="btn" data-view data-id="${p.id}">Ver detalle</button>
          </div>
        </div>
      </article>`;
    }).join('')||'<p class="muted">Sin resultados.</p>';
  }

  // ====== Carrito
  function saveCart(){localStorage.setItem('mh_cart',JSON.stringify(CART))}
  function cartLines(){return CART.map(it=>{const p=PRODUCTS.find(x=>x.id===it.id)||{};return {...p,qty:it.qty,lineTotal:(p.price||0)*it.qty};})}
  function cartSubtotal(){return cartLines().reduce((s,l)=>s+l.lineTotal,0)}
  function updateBadge(){cCount.textContent=CART.reduce((s,i)=>s+i.qty,0)}
  function drawCart(){
    const lines=cartLines();
    cartBody.innerHTML=lines.map(l=>`
      <div class="row">
        <img src="${l.image}" alt="${l.name}" loading="lazy">
        <div>
          <div style="display:flex;justify-content:space-between;gap:8px"><strong>${l.name}</strong><span>${fmt(l.price)}</span></div>
          <div class="qty" style="margin-top:6px">
            <button class="btn" data-plus data-id="${l.id}">+</button>
            <input class="input" style="width:60px;text-align:center" type="number" min="1" value="${l.qty}" data-q="${l.id}">
            <button class="btn" data-minus data-id="${l.id}">‚àí</button>
            <button class="btn" style="margin-left:auto" data-del data-id="${l.id}">üóëÔ∏è</button>
          </div>
        </div>
        <div><strong>${fmt(l.lineTotal)}</strong></div>
      </div>`).join('')||'<p class="muted">Tu carrito est√° vac√≠o.</p>';
    const subtotal=cartSubtotal(); subtotalEl.textContent=fmt(subtotal); grandEl.textContent=fmt(subtotal);
  }
  function addToCart(id,qty=1){const p=PRODUCTS.find(x=>x.id===id); if(!p|| (p.stock|0)<=0) return; const line=CART.find(x=>x.id===id);
    if(line){line.qty=Math.min(line.qty+qty,p.stock|0)}else{CART.push({id,qty:Math.min(qty,p.stock|0||qty)})}
    saveCart();updateBadge();openCart();drawCart();}
  function setQty(id,qty){qty=Math.max(1,qty|0);const p=PRODUCTS.find(x=>x.id===id),line=CART.find(x=>x.id===id); if(!line||!p) return;
    line.qty=Math.min(qty,p.stock|0||qty); saveCart();updateBadge();drawCart();}
  function removeFromCart(id){CART=CART.filter(x=>x.id!==id);saveCart();updateBadge();drawCart();}
  function openCart(){drawer.classList.add('open');drawer.setAttribute('aria-hidden','false');drawCart()}
  function closeCart(){drawer.classList.remove('open');drawer.setAttribute('aria-hidden','true')}

  // ====== Eventos carrito
  btnCart.addEventListener('click',openCart); btnClose.addEventListener('click',closeCart);
  document.addEventListener('keydown',e=>{if(e.key==='Escape'){closeCart();closeModal();closeCheckout()}});

  grid.addEventListener('click',e=>{
    const add=e.target.closest('[data-add]'); const view=e.target.closest('[data-view]');
    if(add){ addToCart(add.dataset.id,1); }
    if(view){ const p=PRODUCTS.find(x=>x.id===view.dataset.id); if(p) openModal(p); }
  });

  cartBody.addEventListener('click',e=>{
    const plus=e.target.closest('[data-plus]'),minus=e.target.closest('[data-minus]'),del=e.target.closest('[data-del]');
    if(plus){const id=plus.dataset.id;const inp=cartBody.querySelector(`[data-q="${id}"]`); if(inp){inp.value=parseInt(inp.value||'1',10)+1; setQty(id,+inp.value)}}
    if(minus){const id=minus.dataset.id;const inp=cartBody.querySelector(`[data-q="${id}"]`); if(inp){inp.value=Math.max(1,parseInt(inp.value||'1',10)-1); setQty(id,+inp.value)}}
    if(del){removeFromCart(del.dataset.id)}
  });
  cartBody.addEventListener('change',e=>{const i=e.target.closest('[data-q]'); if(i){setQty(i.dataset.q,+i.value||1)}});

  // ====== Modal producto
  function openModal(p){
    CURRENT=p;mTitle.textContent=p.name;mImage.src=p.image;mMeta.textContent=[p.set,p.type,p.category].filter(Boolean).join(' ‚Ä¢ ');
    const hasCompare = p.compareAtPrice && p.compareAtPrice > p.price;
    const ahorro = savePct(p);
    mPrice.innerHTML = `<div class="price-wrap"><span class="price-new">${fmt(p.price)}</span>${hasCompare?`<span class="price-old">${fmt(p.compareAtPrice)}</span>${ahorro>0?`<span class="save-tag">Ahorra ${ahorro}%</span>`:''}`:''}</div>`;
    mDesc.textContent=p.description||''; mQty.value=1;
    const gal=Array.isArray(p.images)&&p.images.length?p.images:[p.image];
    mThumbs.innerHTML=gal.map(s=>`<img src="${s}" data-src="${s}" alt="thumb" loading="lazy">`).join('');
    modal.classList.add('open');
  }
  function closeModal(){modal.classList.remove('open');CURRENT=null;}
  mClose.addEventListener('click',closeModal);
  modal.addEventListener('click',e=>{if(e.target===modal) closeModal()});
  $('#mDec').addEventListener('click',()=>mQty.value=Math.max(1,(+mQty.value||1)-1));
  $('#mInc').addEventListener('click',()=>mQty.value=(+mQty.value||1)+1);
  $('#mAdd').addEventListener('click',()=>{if(CURRENT) addToCart(CURRENT.id,+mQty.value||1)});
  $('#mView').addEventListener('click',()=>{if(CURRENT) window.open(CURRENT.image||(CURRENT.images&&CURRENT.images[0])||'', '_blank')});

  // ====== Checkout (Transferencia)
  function openCheckout(){
    if(CART.length===0){alert('Tu carrito est√° vac√≠o.');return;}
    drawer.classList.remove('open');
    coStep1.style.display='block';
    coStep2.style.display='none';
    coModal.classList.add('open');
    const last=JSON.parse(localStorage.getItem('mh_buyer')||'{}');
    coName.value=last.name||''; coRut.value=last.rut||''; coPhone.value=last.phone||''; coEmail.value=last.email||'';
    coMethod.value=last.method||'retiro'; coSlot.value=last.slot||'Tarde (14:00‚Äì18:00)';
    coStreet.value=last.street||''; coUnit.value=last.unit||''; coComuna.value=last.comuna||''; coRef.value=last.ref||''; coContact.value=last.contact||'';
    coNotes.value='';
    toggleAddress();
    buildBankBlock();
  }
  function closeCheckout(){coModal.classList.remove('open')}
  $('#coClose').addEventListener('click',closeCheckout);
  coModal.addEventListener('click',e=>{if(e.target===coModal) closeCheckout()});
  $('#coMethod').addEventListener('change',toggleAddress);
  function toggleAddress(){ coAddressWrap.style.display = (coMethod.value==='despacho') ? 'block' : 'none'; }

  function validateStep1(){
    const rutOk=/^\d{7,8}-[\dkK]$/.test(coRut.value.trim());
    const phoneOk=/^\+?56\s?9\s?\d{4}\s?\d{4}$/.test(coPhone.value.trim()) || /^\+?569\d{8}$/.test(coPhone.value.trim());
    const emailOk=/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(coEmail.value.trim());
    if(!coName.value.trim()) return [false,'Ingresa tu nombre.'];
    if(!rutOk) return [false,'RUT inv√°lido. Formato: 11111111-1'];
    if(!phoneOk) return [false,'WhatsApp inv√°lido. Formato: +56 9 1234 5678'];
    if(!emailOk) return [false,'Email inv√°lido.'];
    if(!coTerms.checked) return [false,'Debes aceptar los t√©rminos.'];
    if(coMethod.value==='despacho'){
      if(!coStreet.value.trim() || !coComuna.value.trim()) return [false,'Para despacho, completa calle y comuna.'];
    }
    return [true,''];
  }

  function orderId(){ const n=Date.now().toString(36).toUpperCase(); return `MH-${n.slice(-6)}`; }

  function buildSummary(id){
    const lines=cartLines();
    const itemsTxt = lines.map(l=>`‚Ä¢ ${l.name} x${l.qty} ‚Äî ${fmt(l.price)} c/u = ${fmt(l.lineTotal)}`).join('\n');
    const total=fmt(cartSubtotal());
    const customer = [
      `Cliente: ${coName.value}`,
      `RUT: ${coRut.value}`,
      `WhatsApp: ${coPhone.value}`,
      `Email: ${coEmail.value}`,
      `Entrega: ${coMethod.value==='retiro'?'Retiro en Valle Grande':'Despacho Zona Norte'}`,
      (coMethod.value==='despacho' ? `Direcci√≥n: ${coStreet.value}, ${coUnit.value||''}, ${coComuna.value}` : `Retiro: Los Nogales 1135, Valle Grande, Lampa`),
      `Horario: ${coSlot.value}`,
      (coNotes.value.trim()?`Notas: ${coNotes.value.trim()}`:'')
    ].filter(Boolean).join('\n');
    return `Pedido ${id}\n${'-'.repeat(18)}\n${itemsTxt}\nTotal: ${total}\n\n${customer}`;
  }

  function buildBankBlock(){
    coBank.textContent =
`Titular: ${BANK.holder}
RUT: ${BANK.rut}
Banco: ${BANK.bank}
Tipo: ${BANK.type}
N¬∞ Cuenta: ${BANK.number}
Email env√≠o comprobante: ${BANK.email}`;
  }

  function toWA(text){ return `https://wa.me/${BANK.whatsapp.replace(/[^0-9]/g,'')}?text=${encodeURIComponent(text)}`; }

  // Paso 1 ‚Üí Paso 2
  $('#coNext').addEventListener('click',()=>{
    const [ok,msg]=validateStep1();
    if(!ok){ alert(msg); return; }
    localStorage.setItem('mh_buyer', JSON.stringify({
      name:coName.value.trim(), rut:coRut.value.trim(), phone:coPhone.value.trim(), email:coEmail.value.trim(),
      method:coMethod.value, slot:coSlot.value, street:coStreet.value.trim(), unit:coUnit.value.trim(),
      comuna:coComuna.value.trim(), ref:coRef.value.trim(), contact:coContact.value.trim()
    }));
    const oid=orderId();
    coSummary.dataset.orderId = oid;
    coSummary.textContent = buildSummary(oid);
    btnWA.href = toWA(`Hola, acabo de realizar un pedido y pagar por transferencia.\n\n${coSummary.textContent}\n\nAdjunto comprobante.`);
    coStep1.style.display='none';
    coStep2.style.display='block';
  });

  // Paso 2 acciones
  $('#coBack').addEventListener('click',()=>{ coStep2.style.display='none'; coStep1.style.display='block'; });
  $('#btnCopySummary').addEventListener('click',async()=>{ await navigator.clipboard.writeText(coSummary.textContent); alert('Resumen copiado.'); });
  $('#btnCopyBank').addEventListener('click',async()=>{ await navigator.clipboard.writeText(coBank.textContent); alert('Datos bancarios copiados.'); });

  $('#coFinish').addEventListener('click',()=>{
    const oid = coSummary.dataset.orderId || orderId();
    alert(`¬°Gracias! Pedido ${oid} registrado.\nRecibir√°s confirmaci√≥n por WhatsApp/Email cuando validemos la transferencia.`);
    CART=[]; saveCart(); updateBadge(); drawCart();
    closeCheckout();
  });

  // Abrir checkout desde el carrito
  $('#btnCheckout').addEventListener('click',openCheckout);

  // ====== Filtros: listeners
  filtersCatEl.addEventListener('click', (e)=>{
    const btn=e.target.closest('.filter-btn'); if(!btn) return;
    const cat=btn.dataset.cat; if(typeof cat==='undefined') return;
    ACTIVE_CATEGORY=(cat==='ALL')?'ALL':cat;
    filtersCatEl.querySelectorAll('.filter-btn').forEach(b=>b.classList.remove('active')); btn.classList.add('active');
    buildTypeFilters(); render();
  });
  filtersTypeEl.addEventListener('click', (e)=>{
    const btn=e.target.closest('.filter-btn'); if(!btn) return;
    const tp=btn.dataset.type; if(typeof tp==='undefined') return;
    ACTIVE_TYPE=(tp==='ALL')?'ALL':tp;
    filtersTypeEl.querySelectorAll('.filter-btn').forEach(b=>b.classList.remove('active')); btn.classList.add('active');
    render();
  });

  // ====== Init
  (async()=>{await loadCatalog()})();
});
</script>
</body>
</html>
