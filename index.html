<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>MasterHit | Cartas Pokémon en Chile</title>
<meta name="description" content="MasterHit: tienda de cartas Pokémon TCG. Envíos a todo Santiago." />
<meta property="og:title" content="MasterHit | Cartas Pokémon en Chile">
<meta property="og:description" content="Cajas selladas, ETB, boosters y singles. Envíos a todo Chile.">
<meta property="og:type" content="website">

<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 256 256'%3E%3Ccircle cx='128' cy='128' r='120' fill='%23e60000'/%3E%3Ccircle cx='128' cy='128' r='88' fill='%23fff'/%3E%3Ccircle cx='128' cy='128' r='40' fill='%23000'/%3E%3C/svg%3E">
<style>
:root{--bg:#0b0b0c;--card:#111215;--muted:#9aa2ae;--line:#20242b;--fg:#f5f7fb;--accent:#e60000;--accent-2:#fff;--radius:16px;--shadow:0 10px 30px rgba(0,0,0,.45)}
*{box-sizing:border-box}html,body{margin:0;height:100%;background:var(--bg);color:var(--fg);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
a{color:inherit;text-decoration:none}img{max-width:100%;display:block}
.container{max-width:1200px;margin:0 auto;padding:20px}

/* NAV */
.nav{position:sticky;top:0;z-index:50;background:#000;border-bottom:2px solid var(--accent)}
.nav-inner{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:14px 20px}
.brand{display:flex;gap:10px;align-items:center;font-weight:800;color:var(--accent-2)}
.brand-badge{position:relative;width:28px;height:28px;border-radius:999px;background:linear-gradient(#e60000 0 50%, #fff 50% 100%);box-shadow:0 0 0 3px #000,0 0 0 6px #fff;overflow:hidden}
.brand-badge:before{content:"";position:absolute;left:0;right:0;top:50%;height:3px;background:#000;transform:translateY(-50%)}
.brand-badge:after{content:"";position:absolute;inset:0;margin:auto;width:10px;height:10px;border-radius:50%;background:#000;box-shadow:0 0 0 3px #fff,0 0 0 5px #000}

/* Buttons */
.btn{cursor:pointer;border-radius:12px;border:1px solid var(--line);background:var(--card);color:var(--fg);padding:10px 14px;display:inline-flex;align-items:center;gap:8px}
.btn.primary{background:var(--accent);border-color:var(--accent);color:#fff}
.cart-count{display:inline-flex;min-width:22px;height:22px;border-radius:999px;align-items:center;justify-content:center;background:#fff;color:#000;font-weight:800;font-size:.85rem;padding:0 6px}

/* HERO */
.hero{padding:36px 20px;text-align:center;background:#111}
.hero h1{font-size:1.6rem;color:#fff;margin:0}
.hero .hero-sub{margin:8px 0 0 0;font-size:1rem;color:#f0f0f0}

/* CONTROLS */
.controls{display:flex;flex-direction:column;gap:10px;padding:0 20px}
.counter{color:var(--fg);font-weight:800;font-size:1.1rem;padding:10px 14px;border-left:3px solid var(--accent);border-radius:8px;background:#0f1116}

/* FILTRO (solo idioma) */
.filters-row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.filters-row .label{color:#cdd3dd}
.chip{cursor:pointer;border-radius:999px;border:1px solid var(--line);background:#0f1116;color:#fff;padding:8px 12px}
.chip.active{background:var(--accent);border-color:var(--accent)}
.clear-btn{margin-left:auto}

/* GRID */
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:14px;padding:20px}
.product{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden;display:flex;flex-direction:column;position:relative}
.product img{height:200px;object-fit:contain;background:#fff}
.pad{padding:12px;flex:1;display:flex;flex-direction:column;gap:8px}
.badge{background:var(--accent);color:#fff;padding:4px 8px;border-radius:6px;font-size:.8rem;position:absolute;margin:6px}
.badge.low{background:rgba(245,158,11,.15);color:#fde68a;border:1px solid rgba(245,158,11,.35)}
.badge.oos{background:#444;color:#ddd;border:1px solid #666}
.badge.cost{background:linear-gradient(90deg,#e60000,#b60000);border:1px solid rgba(255,255,255,.15)}
.badge.preorder{right:6px;top:6px;background:linear-gradient(90deg,#e60000,#b60000);border:1px solid rgba(255,255,255,.15);padding:3px 6px;font-size:.72rem}

/* PRECIOS */
.price-wrap{display:flex;align-items:baseline;gap:10px;flex-wrap:wrap}
.price-new{font-weight:900;font-size:1.05rem;color:#fff}
.price-old{color:var(--muted);text-decoration:line-through}
.save-tag{background:rgba(230,0,0,.15);color:#fff;border:1px solid rgba(230,0,0,.35);padding:2px 8px;border-radius:999px;font-size:.75rem}

/* Drawer carrito */
.drawer{position:fixed;right:0;top:0;height:100%;width:420px;max-width:100%;background:#111;color:#fff;border-left:2px solid var(--accent);transform:translateX(100%);transition:.3s;z-index:100;display:flex;flex-direction:column}
.drawer.open{transform:translateX(0)}
.row{display:grid;grid-template-columns:64px 1fr auto;gap:10px;align-items:center;border:1px solid var(--line);border-radius:12px;padding:8px}
.row img{width:64px;height:64px;object-fit:contain;background:#fff}

/* Modal genérico (queda para el checkout) */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;place-items:center;z-index:90}
.modal.open{display:grid}

/* CHECKOUT modal */
.checkout-card{width:min(780px,95vw);background:#111;border:1px solid var(--line);border-radius:16px;box-shadow:var(--shadow);overflow:hidden}
.checkout-body{padding:16px;display:grid;gap:16px}
.section{border:1px solid var(--line);border-radius:12px;padding:12px}
.section h3{margin:0 0 8px 0;font-size:1rem}
.input, select, textarea{width:100%;border-radius:10px;border:1px solid var(--line);background:#0f1116;color:#fff;padding:10px}
.input::placeholder, textarea::placeholder{color:#9aa2ae}
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.help{font-size:.85rem;color:#9aa2ae}
.flex{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.code{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;background:#0f1116;border:1px dashed var(--line);padding:8px;border-radius:8px}

/* Footer */
footer{padding:24px 20px;background:#000;color:#fff;margin-top:30px}
.footer-inner{max-width:1200px;margin:0 auto;display:grid;gap:6px}
.footer-title{font-weight:800;font-size:1.1rem}

/* Desktop */
@media (min-width:768px){
  .footer-inner{grid-template-columns:1fr auto;align-items:center}
  .footer-btn{justify-self:end}
}

/* Mobile ≤640 */
@media (max-width:640px){
  .grid{grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
  .product img{height:150px}
  .pad{padding:10px}
  .footer-inner{grid-template-columns:1fr;gap:10px;text-align:center}
  .footer-btn{grid-row:1;justify-self:center;margin-bottom:10px}
  .footer-info{grid-row:2}
}
</style>
</head>
<body>

<!-- NAV -->
<nav class="nav" aria-label="Barra superior">
  <div class="nav-inner container">
    <a href="#" class="brand" aria-label="MasterHit inicio"><span class="brand-badge" aria-hidden="true"></span> MASTERHIT</a>
    <div class="toolbar">
      <button id="btnCart" class="btn primary" aria-haspopup="dialog" aria-controls="drawer">
        🛒 Ver tu Carrito de Compras <span class="cart-count" id="cCount">0</span>
      </button>
    </div>
  </div>
</nav>

<!-- HERO -->
<section class="hero" aria-label="Mensaje principal">
  <h1>Los maestros del Pokemon TCG en el Norte de Santiago: nuestra tienda es 100% online para asegurarte el mejor precio.</h1>
  <p class="hero-sub">Aprovecha nuestras Ofertas Insuprables: productos al costo por tiempo limitado.</p>
</section>

<!-- CONTROLS -->
<div class="controls container">
  <span id="counter" class="counter">Sellados Disponibles:</span>

  <!-- SOLO FILTRO DE IDIOMA -->
  <div class="filters-row" role="toolbar" aria-label="Filtros">
    <span class="label">Idioma:</span>
    <div id="rowLang">
      <!-- chips por JS -->
    </div>
    <button id="btnClear" class="chip clear-btn">Limpiar filtros</button>
  </div>
</div>

<!-- GRID -->
<section class="container">
  <div id="grid" class="grid" aria-live="polite"></div>
</section>

<!-- DRAWER CARRITO -->
<aside id="drawer" class="drawer" aria-hidden="true" role="dialog" aria-label="Carrito de compras">
  <header style="padding:12px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;align-items:center">
    <strong>Tu carrito</strong>
    <button id="btnClose" class="btn" aria-label="Cerrar carrito">✕</button>
  </header>
  <div id="cartBody" style="flex:1;overflow:auto;padding:12px"></div>
  <div style="padding:12px;border-top:1px solid var(--line)">
    <div>Subtotal: <strong id="subtotal">—</strong></div>
    <div>Total: <strong id="grand">—</strong></div>
    <button id="btnCheckout" class="btn primary" style="margin-top:10px;width:100%">Proceder a pago (Transferencia)</button>
    <small class="muted">* Único medio de pago: transferencia bancaria.</small>
  </div>
</aside>

<!-- MODAL CHECKOUT (Transferencia) -->
<div id="checkout" class="modal" role="dialog" aria-modal="true" aria-label="Checkout">
  <div class="checkout-card">
    <header style="display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border-bottom:1px solid var(--line)">
      <strong>Finalizar compra (Transferencia)</strong>
      <button id="coClose" class="btn" aria-label="Cerrar checkout">✕</button>
    </header>
    <div class="checkout-body">
      <!-- Paso 1 (simplificado) -->
      <div class="section" id="coStep1">
        <h3>1) Tus datos y entrega</h3>
        <div class="grid-2">
          <div><label>Nombre y Apellido</label><input id="coName" class="input" placeholder="Ej: Jorge Gálvez" autocomplete="name"></div>
          <div><label>WhatsApp</label><input id="coPhone" class="input" placeholder="+56 9 1234 5678" autocomplete="tel"></div>
        </div>
        <div><label>Email</label><input id="coEmail" class="input" placeholder="tucorreo@dominio.cl" autocomplete="email"></div>

        <div class="section" style="margin-top:10px">
          <h3>Elige tu entrega</h3>
          <label class="flex" style="align-items:flex-start">
            <input type="radio" name="coOpt" value="rm" style="margin-top:4px" checked>
            <div>
              <strong>Despacho Región Metropolitana</strong>
              <div class="help">Entrega garantizada entre 1 y 3 días. Horario 18:00 - 21:00 hrs.</div>
            </div>
          </label>
          <label class="flex" style="align-items:flex-start;margin-top:8px">
            <input type="radio" name="coOpt" value="vg" style="margin-top:4px">
            <div>
              <strong>Entrega en Valle Grande, Lampa</strong>
              <div class="help">Disponible en 1 día. Horario: 17:00 - 21:00 hrs.</div>
            </div>
          </label>
          <label class="flex" style="align-items:flex-start;margin-top:8px">
            <input type="radio" name="coOpt" value="ce" style="margin-top:4px">
            <div>
              <strong>Entrega en Ciudad Empresarial, Huechuraba</strong>
              <div class="help">Disponible en 1 día. Horario: 12:00 - 15:00 hrs.</div>
            </div>
          </label>
        </div>

        <div class="flex" style="justify-content:flex-end;margin-top:10px">
          <button id="coNext" class="btn primary">Continuar</button>
        </div>
      </div>

      <!-- Paso 2 -->
      <div class="section" id="coStep2" style="display:none">
        <h3>2) Confirma y transfiere</h3>
        <div class="grid-2">
          <div>
            <strong>Resumen del pedido</strong>
            <div id="coSummary" class="code" style="margin-top:8px;white-space:pre-wrap"></div>
            <div class="flex" style="margin-top:8px"><button id="btnCopySummary" class="btn">Copiar resumen</button></div>
          </div>
          <div>
            <strong>Datos para Transferencia</strong>
            <div id="coBank" class="code" style="margin-top:8px"></div>
            <div class="flex" style="margin-top:8px">
              <button id="btnCopyBank" class="btn">Copiar datos</button>
              <a id="btnWA" class="btn primary" target="_blank" rel="noopener">Enviar por WhatsApp</a>
            </div>
            <p class="help" style="margin-top:8px">Adjunta el comprobante. Validamos y coordinamos la entrega según la opción elegida.</p>
          </div>
        </div>
        <div class="flex" style="justify-content:space-between">
          <button id="coBack" class="btn">Volver</button>
          <button id="coFinish" class="btn primary">He transferido / Finalizar</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- FOOTER -->
<footer>
  <div class="footer-inner">
    <div class="footer-info">
      <div class="footer-title">MasterHit</div>
      <div>Los Nogales 1135, Valle Grande, Lampa</div>
      <div>Lunes a Viernes 14:00 a 21:00 hrs</div>
      <div>Sábados y Domingos 12:00 a 20:00 hrs</div>
    </div>
    <div class="footer-btn">
      <a class="btn primary" href="https://wa.me/56975121963" target="_blank" rel="noopener">📲 Contacta a un ejecutivo</a>
    </div>
  </div>
</footer>

<script>
window.addEventListener('DOMContentLoaded', () => {
  const $=s=>document.querySelector(s),
        fmt=n=>new Intl.NumberFormat('es-CL',{style:'currency',currency:'CLP',maximumFractionDigits:0}).format(n||0),
        uniq=(arr)=>Array.from(new Set(arr.map(x=>(x||'').trim()).filter(Boolean))),
        nlatin=s=>(s||'').toString().normalize('NFD').replace(/\\p{Diacritic}/gu,'').toLowerCase(),
        esc=s=>(s??'').toString().replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

  let PRODUCTS=[], CART=JSON.parse(localStorage.getItem('mh_cart')||'[]');

  /* ====== DATOS BANCARIOS ====== */
  const BANK = { holder:'MasterHit SpA', rut:'77.777.777-7', bank:'Banco Falabella', type:'Cuenta Vista', number:'12345678', email:'pagos@masterhit.cl', whatsapp:'+56975121963' };

  /* ====== Etiquetas desde "source" (preventa/oferta) ====== */
  function getBadgesFromSource(p){
    const out=[]; const src=(p?.source||'').toString().trim();
    if(src){
      const mPre=src.match(/preventa\\s*(\\d{1,2}\\/\\d{1,2})?/i);
      if(mPre){ const label=mPre[1]?`Preventa ${mPre[1]}`:'Preventa'; out.push({type:'preorder',text:label,title:label}); }
      if(/oferta/i.test(src)){ out.push({type:'cost',text:src}); }
    }
    return out;
  }

  /* ====== Filtro idioma ====== */
  let ACTIVE_LANG='ALL';

  /* DOM refs */
  const grid=$('#grid'),counter=$('#counter'),
        btnCart=$('#btnCart'),drawer=$('#drawer'),btnClose=$('#btnClose'),
        cartBody=$('#cartBody'),subtotalEl=$('#subtotal'),grandEl=$('#grand'),cCount=$('#cCount'),
        btnCheckout=$('#btnCheckout'),
        coModal=$('#checkout'),coClose=$('#coClose'),
        coStep1=$('#coStep1'),coStep2=$('#coStep2'),
        coName=$('#coName'),coPhone=$('#coPhone'),coEmail=$('#coEmail'),
        rowLang=$('#rowLang'),btnClear=$('#btnClear'),
        coSummary=$('#coSummary'),coBank=$('#coBank'),
        btnCopySummary=$('#btnCopySummary'),btnCopyBank=$('#btnCopyBank'),btnWA=$('#btnWA'),
        coBack=$('#coBack'),coNext=$('#coNext'),coFinish=$('#coFinish');

  /* Fallback demo */
  const FALLBACK=[
    {id:'spc-prismatic',name:'Prismatic Evolutions',set:'SPC',type:'INGLÉS',price:140000,stock:8,image:'https://dummyimage.com/800x500/fff/000&text=Prismatic+Evolutions',compareAtPrice:179990,source:'Oferta Flash'},
    {id:'garchomp-ex',name:'Garchomp EX',set:'SPECIAL',type:'ESPAÑOL',price:25000,stock:6,image:'https://dummyimage.com/800x500/fff/000&text=Garchomp+EX',compareAtPrice:34990,source:'Oferta Flash'},
    {id:'rivales-predestinados',name:'Rivales Predestinados',set:'ETB',type:'ESPAÑOL',price:40000,stock:5,image:'https://dummyimage.com/800x500/fff/000&text=Rivales+Predestinados',compareAtPrice:54990,source:'Oferta Flash'},
    {id:'charizard-ex',name:'Charizard EX',set:'SPECIAL',type:'ESPAÑOL',price:25000,stock:10,image:'https://dummyimage.com/800x500/fff/000&text=Charizard+EX',compareAtPrice:34990,source:'Oferta Flash'},
    {id:'mega-evo-upc',name:'Mega Evolutions UPC',set:'UPC',type:'INGLÉS',price:129990,stock:7,image:'https://dummyimage.com/800x500/fff/000&text=Mega+Evolutions+UPC',compareAtPrice:149990,source:'Preventa 26/09'}
  ];

  async function loadCatalog(){
    try{
      const r=await fetch('./masterhit-products.json?_='+Date.now());
      if(!r.ok) throw 0;
      const d=await r.json();
      PRODUCTS = Array.isArray(d)&&d.length? d.map(x=>({
        ...x,
        price:+x.price||0,
        compareAtPrice: x.compareAtPrice===''||x.compareAtPrice===null? null : (+x.compareAtPrice||0),
        stock:+x.stock||0
      })) : FALLBACK;
    }catch{ PRODUCTS=FALLBACK }
    counter.textContent='Sellados Disponibles:'; buildLangChips(); render(); updateBadge();
  }

  /* Helpers */
  const savePct = (p) => (p && p.compareAtPrice && p.compareAtPrice > p.price)
    ? Math.round((1 - (p.price / p.compareAtPrice)) * 100) : 0;

  function metaLine(p){ return uniq([p.set,p.type]).join(' • '); }

  function getList(){
    let list=[...PRODUCTS];
    if(ACTIVE_LANG!=='ALL'){ list=list.filter(p=>nlatin(p.type)===nlatin(ACTIVE_LANG)); }
    return list.sort((a,b)=>(b.stock|0)-(a.stock|0));
  }

  function render(){
    const list=getList();
    grid.innerHTML = list.map((p)=>{
      const low=(p.stock|0)>0 && (p.stock|0)<=3, oos=(p.stock|0)===0;
      const hasCompare=p.compareAtPrice && p.compareAtPrice>p.price;
      const ahorro=savePct(p);
      const badges=getBadgesFromSource(p);
      const bCost=badges.find(b=>b.type==='cost');
      const bPre=badges.find(b=>b.type==='preorder');

      return `<article class="product">
        ${bCost ? `<span class="badge cost" title="${esc(bCost.title||'')}">${esc(bCost.text)}</span>` : ``}
        ${bPre  ? `<span class="badge preorder" title="${esc(bPre.title||'')}">${esc(bPre.text)}</span>` : ``}
        ${oos?`<span class="badge oos">Sin stock</span>`:low?`<span class="badge low">¡Quedan ${p.stock}!</span>`:''}
        <img src="${p.image}" alt="${esc(p.name)}" loading="lazy" decoding="async" referrerpolicy="no-referrer">
        <div class="pad">
          <strong>${esc(p.name)}</strong>
          <span class="muted">${esc(metaLine(p))}</span>
          <div class="price-wrap">
            <span class="price-new">${fmt(p.price)}</span>
            ${hasCompare?`<span class="price-old">${fmt(p.compareAtPrice)}</span>${ahorro>0?`<span class="save-tag">Ahorra ${ahorro}%</span>`:''}`:''}
          </div>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button class="btn primary" data-add data-id="${esc(p.id)}" ${oos?'disabled':''}>Añadir</button>
          </div>
        </div>
      </article>`;
    }).join('') || '<p class="muted">Sin resultados.</p>';
  }

  /* ====== Carrito ====== */
  function saveCart(){localStorage.setItem('mh_cart',JSON.stringify(CART))}
  function cartLines(){return CART.map(it=>{const p=PRODUCTS.find(x=>x.id===it.id)||{};return {...p,qty:it.qty,lineTotal:(p.price||0)*it.qty};})}
  function cartSubtotal(){return cartLines().reduce((s,l)=>s+l.lineTotal,0)}
  function updateBadge(){cCount.textContent=CART.reduce((s,i)=>s+i.qty,0)}
  function drawCart(){
    const lines=cartLines();
    cartBody.innerHTML=lines.map(l=>`
      <div class="row">
        <img src="${l.image}" alt="${esc(l.name)}" loading="lazy">
        <div>
          <div style="display:flex;justify-content:space-between;gap:8px"><strong>${esc(l.name)}</strong><span>${fmt(l.price)}</span></div>
          <div class="qty" style="margin-top:6px">
            <button class="btn" data-plus data-id="${esc(l.id)}">+</button>
            <input class="input" style="width:60px;text-align:center" type="number" min="1" value="${l.qty}" data-q="${esc(l.id)}">
            <button class="btn" data-minus data-id="${esc(l.id)}">−</button>
            <button class="btn" style="margin-left:auto" data-del data-id="${esc(l.id)}">🗑️</button>
          </div>
        </div>
        <div><strong>${fmt(l.lineTotal)}</strong></div>
      </div>`).join('')||'<p class="muted">Tu carrito está vacío.</p>';
    const subtotal=cartSubtotal(); subtotalEl.textContent=fmt(subtotal); grandEl.textContent=fmt(subtotal);
  }
  function addToCart(id,qty=1){const p=PRODUCTS.find(x=>x.id===id); if(!p|| (p.stock|0)<=0) return; const line=CART.find(x=>x.id===id);
    if(line){line.qty=Math.min(line.qty+qty,p.stock|0)}else{CART.push({id,qty:Math.min(qty,p.stock|0||qty)})}
    saveCart();updateBadge();openCart();drawCart();}
  function setQty(id,qty){qty=Math.max(1,qty|0);const p=PRODUCTS.find(x=>x.id===id),line=CART.find(x=>x.id===id); if(!line||!p) return;
    line.qty=Math.min(qty,p.stock|0||qty); saveCart();updateBadge();drawCart();}
  function removeFromCart(id){CART=CART.filter(x=>x.id!==id);saveCart();updateBadge();drawCart();}
  function openCart(){drawer.classList.add('open');drawer.setAttribute('aria-hidden','false');drawCart()}
  function closeCart(){drawer.classList.remove('open');drawer.setAttribute('aria-hidden','true')}

  /* ====== Checkout (transferencia) ====== */
  function openCheckout(){
    if(CART.length===0){alert('Tu carrito está vacío.');return;}
    drawer.classList.remove('open');
    coStep1.style.display='block'; coStep2.style.display='none'; coModal.classList.add('open');
    const last=JSON.parse(localStorage.getItem('mh_buyer_simple')||'{}');
    coName.value=last.name||''; coPhone.value=last.phone||''; coEmail.value=last.email||'';
    // opción previa
    const prev = last.opt || 'rm';
    const radios = document.querySelectorAll('input[name="coOpt"]');
    radios.forEach(r=>{ r.checked = (r.value===prev); });
    buildBankBlock();
  }
  function closeCheckout(){coModal.classList.remove('open')}

  function validateStep1(){
    const phoneOk=/^\\+?56\\s?9\\s?\\d{4}\\s?\\d{4}$/.test(coPhone.value.trim()) || /^\\+?569\\d{8}$/.test(coPhone.value.trim());
    const emailOk=/^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/.test(coEmail.value.trim());
    if(!coName.value.trim()) return [false,'Ingresa tu nombre.'];
    if(!phoneOk) return [false,'WhatsApp inválido.'];
    if(!emailOk) return [false,'Email inválido.'];
    const opt = (document.querySelector('input[name="coOpt"]:checked')||{}).value;
    if(!opt) return [false,'Selecciona una opción de entrega.'];
    return [true,''];
  }

  function orderId(){ const n=Date.now().toString(36).toUpperCase(); return `MH-${n.slice(-6)}`; }

  function optText(opt){
    if(opt==='rm') return 'Despacho Región Metropolitana — 1 a 3 días (18:00–21:00)';
    if(opt==='vg') return 'Entrega en Valle Grande, Lampa — 1 día (17:00–21:00)';
    if(opt==='ce') return 'Entrega en Ciudad Empresarial, Huechuraba — 1 día (12:00–15:00)';
    return '';
  }

  function buildSummary(id,opt){
    const items=cartLines().map(l=>`• ${l.name} x${l.qty} — ${fmt(l.price)} c/u = ${fmt(l.lineTotal)}`).join('\\n');
    const total=fmt(cartSubtotal());
    return `Pedido ${id}
------------------
${items}
Total: ${total}

Cliente: ${coName.value}
WhatsApp: ${coPhone.value}
Email: ${coEmail.value}
Entrega: ${optText(opt)}`;
  }

  function buildBankBlock(){
    coBank.textContent = `Titular: ${BANK.holder}
RUT: ${BANK.rut}
Banco: ${BANK.bank}
Tipo: ${BANK.type}
N° Cuenta: ${BANK.number}
Email envío comprobante: ${BANK.email}`;
  }
  function toWA(text){ return `https://wa.me/${BANK.whatsapp.replace(/[^0-9]/g,'')}?text=${encodeURIComponent(text)}`; }

  /* ====== Eventos ====== */
  btnCart.addEventListener('click',openCart);
  btnClose.addEventListener('click',closeCart);
  document.addEventListener('keydown',e=>{if(e.key==='Escape'){closeCart();closeCheckout()}});

  grid.addEventListener('click',e=>{
    const add=e.target.closest('[data-add]');
    if(add){ addToCart(add.dataset.id,1); }
  });

  cartBody.addEventListener('click',e=>{
    const plus=e.target.closest('[data-plus]'),minus=e.target.closest('[data-minus]'),del=e.target.closest('[data-del]');
    if(plus){const id=plus.dataset.id;const inp=cartBody.querySelector(\`[data-q="\${id}"]\`); if(inp){inp.value=parseInt(inp.value||'1',10)+1; setQty(id,+inp.value)}}
    if(minus){const id=minus.dataset.id;const inp=cartBody.querySelector(\`[data-q="\${id}"]\`); if(inp){inp.value=Math.max(1,parseInt(inp.value||'1',10)-1); setQty(id,+inp.value)}}
    if(del){removeFromCart(del.dataset.id)}
  });
  cartBody.addEventListener('change',e=>{const i=e.target.closest('[data-q]'); if(i){setQty(i.dataset.q,+i.value||1)}});

  // Checkout
  btnCheckout.addEventListener('click',openCheckout);
  coClose.addEventListener('click',closeCheckout);
  coModal.addEventListener('click',e=>{if(e.target===coModal) closeCheckout()});

  coNext.addEventListener('click',()=>{
    const [ok,msg]=validateStep1(); if(!ok){alert(msg);return;}
    const opt=(document.querySelector('input[name="coOpt"]:checked')||{}).value;
    localStorage.setItem('mh_buyer_simple', JSON.stringify({
      name:coName.value.trim(), phone:coPhone.value.trim(), email:coEmail.value.trim(), opt
    }));
    const oid=orderId(); coSummary.dataset.orderId=oid; coSummary.dataset.opt=opt;
    coSummary.textContent=buildSummary(oid,opt);
    btnWA.href = toWA(\`Hola, acabo de realizar un pedido y pagar por transferencia.\\n\\n\${coSummary.textContent}\\n\\nAdjunto comprobante.\`);
    coStep1.style.display='none'; coStep2.style.display='block';
  });

  coBack.addEventListener('click',()=>{coStep2.style.display='none';coStep1.style.display='block'});

  btnCopySummary.addEventListener('click',async()=>{await navigator.clipboard.writeText(coSummary.textContent);alert('Resumen copiado.')});
  btnCopyBank.addEventListener('click',async()=>{await navigator.clipboard.writeText(coBank.textContent);alert('Datos bancarios copiados.')});

  coFinish.addEventListener('click',()=>{
    const oid=coSummary.dataset.orderId||orderId();
    alert(\`¡Gracias! Pedido \${oid} registrado. Te contactaremos por WhatsApp/Email.\`);
    CART=[]; saveCart(); updateBadge(); drawCart(); closeCheckout();
  });

  // Filtro idioma
  function buildLangChips(){
    const langs = uniq(PRODUCTS.map(p=>p.type)).sort((a,b)=>a.localeCompare(b));
    const chips = [\`<button class="chip \${ACTIVE_LANG==='ALL'?'active':''}" data-lang="ALL">Todos</button>\`]
      .concat(langs.map(l=>\`<button class="chip \${nlatin(ACTIVE_LANG)===nlatin(l)?'active':''}" data-lang="\${l}">\${l}</button>\`));
    rowLang.innerHTML = chips.join('');
  }
  rowLang.addEventListener('click',e=>{
    const chip=e.target.closest('.chip'); if(!chip) return;
    const l=chip.dataset.lang; if(typeof l==='undefined') return;
    ACTIVE_LANG=(l==='ALL')?'ALL':l;
    rowLang.querySelectorAll('.chip').forEach(c=>c.classList.remove('active')); chip.classList.add('active');
    render();
  });
  btnClear.addEventListener('click',()=>{ACTIVE_LANG='ALL'; buildLangChips(); render();});

  // Init
  (async()=>{await loadCatalog()})();
});
</script>
</body>
</html>

